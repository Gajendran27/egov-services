
server{
		listen 80;
		resolver 127.0.0.1:53 ipv6=off;
		underscores_in_headers on;
        gzip on;
        gzip_proxied any;
        gzip_types text/plain text/xml text/css application/json application/x-javascript text/javascript application/javascript;
        gzip_vary on;
        gzip_disable "MSIE [1-6]\.(?!.*SV1)";
        gzip_comp_level 6;
        gzip_buffers 16 8k;
        gzip_min_length 512;
        set $asset_web http://asset-web;
		set $react_pgr_web http://react-pgr-web;
		set $api_gateway http://zuul;
		set $redoc_web http://redoc;
		set $prometheus http://prometheus.monitoring;
		set $grafana http://grafana.monitoring;
		set $alertmanager http://alertmanager.monitoring;
		set $spec_directory http://spec-directory;
        set $lets_encrypt http://lets-encrypt;
        set $service_docs http://service-docs;
        set $rainmaker_employee http://employee;
        set $rainmaker_citizen http://citizen;
        set $pgr_web http://pgr-web;

    location /citizen {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        client_max_body_size 2M;
        proxy_pass $rainmaker_citizen:80;
        proxy_pass_request_headers on;
        proxy_read_timeout 90;
    }

    location /employee {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        client_max_body_size 2M;
        proxy_pass $rainmaker_employee:80;
        proxy_pass_request_headers on;
        proxy_read_timeout 90;
    }

    location /app/docs/ {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        client_max_body_size 2M;
        proxy_pass $service_docs;
        proxy_pass_request_headers on;
        proxy_read_timeout 90;
    }

    location ^~ /.well-known/acme-challenge {                  
    allow all;                                                              
    alias /var/www/acme;                                                    
    }


	location / {        
        return 301 https://$host/citizen;  
	}

	location /react-pgr-web {
   			rewrite ^/react-pgr-web(.*) /app/v1$1 permanent;
 	}


	location /redoc {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        client_max_body_size 2M;
        proxy_pass $redoc_web:80;
        proxy_pass_request_headers on;
        proxy_read_timeout 90;
	}



    location /spec-directory {
        proxy_pass $spec_directory:4022;
        proxy_set_header Host  $host:$server_port;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass_request_headers on;
        proxy_read_timeout 90;
        client_max_body_size 100M;
    }


	location ~ ^/(pgr|egov-location|localization|user|workflow|eis|user-otp|otp|hr-masters-v2|egov-common-masters|hr-employee-v2|demand-services|egov-common-workflows|tenant|wcms/masters|pgr-master|billing-service|access|egov-idgen|egov-pg-service|pt-calculator-v2|pt-services-v2|rainmaker-pgr|infra-search/egov-searcher|perfmanagement|egov-persister|egov-indexer|egov-mdms-service|report)/ {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        client_max_body_size 2M;
        proxy_pass $api_gateway:8080;
        proxy_pass_request_headers on;
        proxy_read_timeout 90;
      }

	location /filestore {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        client_max_body_size 100M;
        proxy_pass $api_gateway:8080;
        proxy_pass_request_headers on;
        proxy_read_timeout 90;
      }
	location /prometheus {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        client_max_body_size 40M;
        proxy_pass $prometheus:9090;
        proxy_pass_request_headers on;
        proxy_read_timeout 90;
      }
	location /grafana/ {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        client_max_body_size 40M;
        proxy_pass $grafana:3000/;
        proxy_pass_request_headers on;
        proxy_read_timeout 90;
      }
	location /alertmanager {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        client_max_body_size 40M;
        proxy_pass $alertmanager:9093;
				proxy_pass_request_headers on;
        proxy_read_timeout 90;
      }
}
